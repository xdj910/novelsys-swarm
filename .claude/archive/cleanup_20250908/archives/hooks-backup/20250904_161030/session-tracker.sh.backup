#!/bin/bash

# PostToolUse Hook: Writing session tracker
# è¿½è¸ªå†™ä½œæ´»åŠ¨ï¼šä¼šè¯æ—¶é•¿ã€å­—æ•°å˜åŒ–ã€æ–‡ä»¶ä¿®æ”¹ã€ç”ŸæˆæŠ¥å‘Š

# è®¾ç½®é¡¹ç›®æ ¹ç›®å½• (æ ¹æ®Claude Codeå®˜æ–¹æ–‡æ¡£)
if [[ -z "$CLAUDE_PROJECT_DIR" ]]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
    echo "[WARNING] CLAUDE_PROJECT_DIR not set, using fallback: $PROJECT_ROOT" >&2
else
    PROJECT_ROOT="$CLAUDE_PROJECT_DIR"
fi

# ç¡®ä¿æ—¥å¿—å’Œä¼šè¯ç›®å½•å­˜åœ¨
mkdir -p "$PROJECT_ROOT/.claude/logs"
mkdir -p "$PROJECT_ROOT/.claude/sessions"

# ä»stdinè¯»å–Claude Codeæä¾›çš„JSONè¾“å…¥
input=$(cat)

# ä½¿ç”¨jqè§£æJSONè¾“å…¥
tool_name=$(echo "$input" | jq -r '.tool_name // .tool // .name // empty' 2>/dev/null)
file_path=$(echo "$input" | jq -r '.tool_input.file_path // .file_path // .path // empty' 2>/dev/null)

# Fallbackåˆ°grep
[[ -z "$tool_name" ]] && tool_name=$(echo "$input" | grep -o '"tool_name"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4 2>/dev/null)
[[ -z "$file_path" ]] && file_path=$(echo "$input" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4 2>/dev/null)

# Convert Windows paths to Unix paths for compatibility
unix_path=$(echo "$file_path" | sed 's|\\|/|g' | sed 's|^D:|/d|' | sed 's|^C:|/c|')

# å½“å‰æ—¶é—´æˆ³
current_time=$(date '+%Y-%m-%d %H:%M:%S')
current_timestamp=$(date '+%s')
session_date=$(date '+%Y%m%d')

# ä¼šè¯æ–‡ä»¶è·¯å¾„
session_file="$PROJECT_ROOT/.claude/sessions/session_$session_date.json"
daily_summary="$PROJECT_ROOT/.claude/sessions/daily_${session_date}.md"

# æ£€æŸ¥æ˜¯å¦æ˜¯å†™ä½œç›¸å…³æ“ä½œ
if [[ "$tool_name" == "Write" || "$tool_name" == "Edit" || "$tool_name" == "MultiEdit" ]]; then
    
    # åˆå§‹åŒ–ä¼šè¯æ–‡ä»¶ (å¦‚æœä¸å­˜åœ¨)
    if [[ ! -f "$session_file" ]]; then
        cat > "$session_file" << EOF
{
  "session_date": "$session_date",
  "session_start": "$current_time",
  "last_activity": "$current_time",
  "total_operations": 0,
  "files_modified": [],
  "word_changes": {},
  "chapters_worked_on": [],
  "operation_log": [],
  "session_stats": {
    "total_words_added": 0,
    "total_words_removed": 0,
    "net_word_change": 0,
    "files_created": 0,
    "files_edited": 0,
    "chapters_touched": 0
  }
}
EOF
        echo "ğŸ“ Started new writing session for $(date '+%Y-%m-%d')"
    fi
    
    # æ£€æµ‹æ–‡ä»¶ç±»å‹å’Œæ“ä½œç±»å‹
    file_type="other"
    operation_details=""
    word_change=0
    
    if ([[ "$file_path" == */content.md ]] || [[ "$file_path" == *\\content.md ]]); then
        file_type="chapter_content"
        
        # æå–ç« èŠ‚å·
        if ([[ "$file_path" == */chapters/ch*/content.md ]] || [[ "$file_path" == *\\chapters\\ch*\\content.md ]]); then
            chapter_dir=$(dirname "$unix_path")
            chapter_num=$(basename "$chapter_dir" | sed 's/ch0*//')
            operation_details="Chapter $chapter_num content"
            
            # è®¡ç®—å­—æ•°å˜åŒ– (å¦‚æœæ–‡ä»¶å·²å­˜åœ¨)
            if [[ -f "$unix_path" && "$tool_name" == "Edit" ]]; then
                # å¯¹äºç¼–è¾‘æ“ä½œï¼Œå°è¯•ä¼°ç®—å­—æ•°å˜åŒ–
                current_words=$(wc -w "$unix_path" 2>/dev/null | cut -d' ' -f1 || echo "0")
                
                # ä»ä¼šè¯è®°å½•ä¸­è·å–ä¹‹å‰çš„å­—æ•°
                prev_words=$(jq -r ".word_changes[\"$file_path\"] // 0" "$session_file" 2>/dev/null || echo "0")
                
                if [[ "$prev_words" != "0" && "$current_words" =~ ^[0-9]+$ && "$prev_words" =~ ^[0-9]+$ ]]; then
                    word_change=$((current_words - prev_words))
                fi
            elif [[ "$tool_name" == "Write" && -f "$unix_path" ]]; then
                # æ–°å†™å…¥æ–‡ä»¶
                word_change=$(wc -w "$unix_path" 2>/dev/null | cut -d' ' -f1 || echo "0")
            fi
        fi
        
    elif ([[ "$file_path" == */meta.json ]] || [[ "$file_path" == *\\meta.json ]]); then
        file_type="metadata"
        operation_details="Chapter metadata"
        
    elif ([[ "$file_path" == *bible.yaml ]] || [[ "$file_path" == *\\bible.yaml ]]) || ([[ "$file_path" == *bible.yml ]] || [[ "$file_path" == *\\bible.yml ]]); then
        file_type="bible"
        operation_details="Series Bible"
        
    elif ([[ "$file_path" == */quality_check.json ]] || [[ "$file_path" == *\\quality_check.json ]]); then
        file_type="quality_report"
        operation_details="Quality assessment"
        
    elif [[ "$file_path" == *.md ]]; then
        file_type="documentation"
        operation_details="Documentation"
        
    else
        operation_details="Other file: $(basename "$file_path")"
    fi
    
    # æ›´æ–°ä¼šè¯è®°å½•
    temp_session="$session_file.tmp"
    
    # ä½¿ç”¨jqæ›´æ–°ä¼šè¯æ•°æ®
    current_word_count=0
    if [[ -f "$unix_path" ]]; then
        current_word_count=$(wc -w "$unix_path" 2>/dev/null | cut -d' ' -f1 || echo "0")
    fi
    
    jq --arg timestamp "$current_time" \
       --arg tool "$tool_name" \
       --arg file_path "$file_path" \
       --arg file_type "$file_type" \
       --arg details "$operation_details" \
       --arg word_change "$word_change" \
       --arg current_words "$current_word_count" \
       --arg chapter_num "${chapter_num:-""}" \
       '. + {
           "last_activity": $timestamp,
           "total_operations": (.total_operations + 1)
       } |
       .files_modified += [$file_path] | .files_modified |= unique |
       .word_changes[$file_path] = ($current_words | tonumber) |
       if $chapter_num != "" then 
           .chapters_worked_on += [$chapter_num] | .chapters_worked_on |= unique
       else . end |
       .operation_log += [{
           "timestamp": $timestamp,
           "tool": $tool,
           "file_path": $file_path,
           "file_type": $file_type,
           "operation": $details,
           "word_change": ($word_change | tonumber)
       }] |
       if ($word_change | tonumber) > 0 then
           .session_stats.total_words_added += ($word_change | tonumber)
       elif ($word_change | tonumber) < 0 then
           .session_stats.total_words_removed += (($word_change | tonumber) * -1)
       else . end |
       .session_stats.net_word_change += ($word_change | tonumber) |
       if $tool == "Write" then
           .session_stats.files_created += 1
       else
           .session_stats.files_edited += 1
       end |
       .session_stats.files_edited = (.files_modified | length) |
       .session_stats.chapters_touched = (.chapters_worked_on | length)' \
       "$session_file" > "$temp_session" 2>/dev/null
    
    # æ£€æŸ¥jqæ˜¯å¦æˆåŠŸ
    if [[ $? -eq 0 && -s "$temp_session" ]]; then
        mv "$temp_session" "$session_file"
        
        # è®°å½•æ´»åŠ¨åˆ°æ—¥å¿—
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] Session activity: $tool_name -> $operation_details" >> "$PROJECT_ROOT/.claude/logs/session-tracking.log"
        
        # ç”¨æˆ·æç¤º (ç®€æ´ç‰ˆ)
        if [[ "$word_change" -gt 0 ]]; then
            echo "ğŸ“Š Session: +$word_change words ($operation_details)"
        elif [[ "$word_change" -lt 0 ]]; then
            abs_change=$((-word_change))
            echo "ğŸ“Š Session: -$abs_change words ($operation_details)"
        else
            echo "ğŸ“Š Session: $operation_details updated"
        fi
        
    else
        # jqå¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ—¥å¿—è®°å½•
        rm -f "$temp_session" 2>/dev/null
        echo "[$current_time] $tool_name: $operation_details (word_change: $word_change)" >> "$PROJECT_ROOT/.claude/logs/session-simple.log"
    fi
    
    # æ¯éš”ä¸€å®šæ“ä½œæ•°ç”Ÿæˆä¼šè¯æ‘˜è¦
    if [[ -f "$session_file" ]]; then
        total_ops=$(jq -r '.total_operations // 0' "$session_file" 2>/dev/null || echo "0")
        
        # æ¯10æ¬¡æ“ä½œæˆ–æ¯å°æ—¶ç”Ÿæˆä¸€æ¬¡æ‘˜è¦
        if [[ "$total_ops" =~ ^[0-9]+$ ]] && [[ $((total_ops % 10)) -eq 0 ]]; then
            
            # ç”Ÿæˆä¼šè¯æ‘˜è¦
            session_start=$(jq -r '.session_start // ""' "$session_file" 2>/dev/null)
            net_words=$(jq -r '.session_stats.net_word_change // 0' "$session_file" 2>/dev/null)
            chapters_count=$(jq -r '.session_stats.chapters_touched // 0' "$session_file" 2>/dev/null)
            
            cat > "$daily_summary" << EOF
# Writing Session Summary - $(date '+%Y-%m-%d')

## Session Overview
- **Started**: $session_start
- **Last Activity**: $current_time  
- **Total Operations**: $total_ops
- **Net Word Change**: $net_words words
- **Chapters Worked On**: $chapters_count

## Recent Activity
$(jq -r '.operation_log | reverse | .[0:5] | .[] | "- " + .timestamp + ": " + .operation + " (" + (.word_change | tostring) + " words)"' "$session_file" 2>/dev/null | head -5)

## Session Statistics
$(jq -r '
"- Files Created: " + (.session_stats.files_created | tostring) + "
- Files Edited: " + (.session_stats.files_edited | tostring) + "  
- Words Added: " + (.session_stats.total_words_added | tostring) + "
- Words Removed: " + (.session_stats.total_words_removed | tostring) + "
- Chapters Touched: " + (.session_stats.chapters_touched | tostring)
' "$session_file" 2>/dev/null)

---
*Auto-generated by session-tracker Hook*
EOF
            
            echo "ğŸ“‹ Session summary updated (after $total_ops operations)"
        fi
    fi
fi

# æˆåŠŸé€€å‡º
exit 0