# Subagentè¾“å‡ºä¿æŠ¤ç³»ç»Ÿ

## é—®é¢˜èƒŒæ™¯

Subagentåœ¨ç”Ÿæˆæ–‡ä»¶æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š
- ğŸ“„ æ–‡ä»¶è¢«æˆªæ–­ï¼ˆç‰¹åˆ«æ˜¯é•¿å†…å®¹ï¼‰
- ğŸ”§ JSON/YAMLæ ¼å¼é”™è¯¯
- âŒ ç¼ºå°‘å¿…è¦å­—æ®µæˆ–ç»“æ„
- ğŸ“ å†…å®¹ä¸å®Œæ•´æˆ–æ ¼å¼æ··ä¹±
- ğŸ”¤ ç¼–ç é—®é¢˜å¯¼è‡´çš„ä¹±ç 

## ä¸‰å±‚ä¿æŠ¤æœºåˆ¶

### ç¬¬ä¸€å±‚ï¼šå®æ—¶éªŒè¯ (subagent-output-validator.sh)

**è§¦å‘æ—¶æœº**ï¼šæ–‡ä»¶å†™å…¥åç«‹å³æ‰§è¡Œ
**åŠŸèƒ½**ï¼š
- éªŒè¯JSON/YAMLè¯­æ³•
- æ£€æŸ¥å¿…è¦å­—æ®µå­˜åœ¨æ€§
- éªŒè¯æ•°æ®èŒƒå›´åˆç†æ€§
- æ£€æµ‹æ–‡ä»¶æˆªæ–­
- ç”ŸæˆéªŒè¯æŠ¥å‘Š

**éªŒè¯è§„åˆ™**ï¼š
```yaml
JSONæ–‡ä»¶:
  - è¯­æ³•å¿…é¡»æœ‰æ•ˆ
  - meta.jsonå¿…é¡»æœ‰: chapter_number, word_count, last_modified
  - quality_check.jsonçš„åˆ†æ•°å¿…é¡»åœ¨0-100ä¹‹é—´

YAMLæ–‡ä»¶:
  - è¯­æ³•å¿…é¡»æœ‰æ•ˆ
  - bible.yamlå¿…é¡»æœ‰: title, characters, universe
  - entity_dictionaryå¿…é¡»æœ‰åŸºæœ¬ç»“æ„

Markdownæ–‡ä»¶:
  - content.mdå¿…é¡»æœ‰ç« èŠ‚æ ‡é¢˜
  - å†…å®¹ä¸èƒ½ä¸ºç©º
  - å­—æ•°åº”å¤§äº50
```

### ç¬¬äºŒå±‚ï¼šè‡ªåŠ¨ä¿®å¤ (auto-output-fixer.sh)

**è§¦å‘æ—¶æœº**ï¼šéªŒè¯åè‡ªåŠ¨æ‰§è¡Œ
**ä¿®å¤èƒ½åŠ›**ï¼š

#### JSONä¿®å¤
- âœ… ç§»é™¤å°¾éšé€—å·
- âœ… ä¿®å¤æœªé—­åˆå¼•å·
- âœ… æ·»åŠ ç¼ºå¤±çš„å¿…è¦å­—æ®µ
- âœ… ä¿®æ­£æ•°æ®ç±»å‹

#### YAMLä¿®å¤
- âœ… ä¿®å¤ç¼©è¿›é—®é¢˜
- âœ… æ›¿æ¢åˆ¶è¡¨ç¬¦ä¸ºç©ºæ ¼
- âœ… æ·»åŠ ç¼ºå¤±çš„é¡¶çº§ç»“æ„
- âœ… ä¿®å¤åŸºæœ¬è¯­æ³•é”™è¯¯

#### Markdownä¿®å¤
- âœ… æ·»åŠ ç¼ºå¤±çš„ç« èŠ‚æ ‡é¢˜
- âœ… ä¿®å¤ç¼–ç é—®é¢˜ï¼ˆå¦‚æ™ºèƒ½å¼•å·ï¼‰
- âœ… æ¸…ç†å¤šä½™ç©ºè¡Œ
- âœ… æ·»åŠ æˆªæ–­è­¦å‘Šæ ‡è®°

### ç¬¬ä¸‰å±‚ï¼šäººå·¥ä»‹å…¥æé†’

å½“è‡ªåŠ¨ä¿®å¤å¤±è´¥æ—¶ï¼š
- ğŸš¨ ç”Ÿæˆå¤±è´¥æŠ¥å‘Šåˆ° `.claude/validation/`
- ğŸ“ è®°å½•åˆ° `.claude/logs/validation.log`
- âš ï¸ æ ‡è®°å…³é”®æ–‡ä»¶éœ€è¦ç«‹å³ä¿®å¤
- ğŸ’¾ ä¿ç•™åŸå§‹æ–‡ä»¶å¤‡ä»½

## æ–‡ä»¶æˆªæ–­æ£€æµ‹

ç‰¹åˆ«é’ˆå¯¹Subagentå®¹æ˜“å‡ºç°çš„æˆªæ–­é—®é¢˜ï¼š

```bash
æ£€æµ‹æ–¹æ³•:
1. æ£€æŸ¥æ–‡ä»¶ç»“å°¾æ˜¯å¦æ­£å¸¸
2. æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„å¥å­
3. æ£€æŸ¥JSON/YAMLæ˜¯å¦å®Œæ•´é—­åˆ
4. æ£€æŸ¥ç« èŠ‚æ˜¯å¦æœ‰ç»“å°¾æ ‡è®°

å¤„ç†æ–¹å¼:
- è½»å¾®æˆªæ–­ â†’ è‡ªåŠ¨æ·»åŠ æ ‡è®°
- ä¸¥é‡æˆªæ–­ â†’ ç”Ÿæˆè­¦å‘ŠæŠ¥å‘Š
- JSONæˆªæ–­ â†’ å°è¯•è¡¥å…¨ç»“æ„
- å†…å®¹æˆªæ–­ â†’ æ·»åŠ  [TRUNCATED] æ ‡è®°
```

## å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šJSONå°¾éšé€—å·
```json
// Subagentç”Ÿæˆçš„é”™è¯¯JSON
{
  "chapter": 1,
  "title": "Beginning",  // â† é”™è¯¯çš„é€—å·
}

// è‡ªåŠ¨ä¿®å¤å
{
  "chapter": 1,
  "title": "Beginning"
}
```

### æ¡ˆä¾‹2ï¼šç« èŠ‚å†…å®¹æˆªæ–­
```markdown
# Subagentç”Ÿæˆçš„æˆªæ–­å†…å®¹
Sarah walked into the room and suddenly

// è‡ªåŠ¨ä¿®å¤å
Sarah walked into the room and suddenly

*[Chapter appears incomplete - pending continuation]*
```

### æ¡ˆä¾‹3ï¼šç¼ºå¤±å¿…è¦å­—æ®µ
```json
// Subagentç”Ÿæˆçš„ä¸å®Œæ•´meta.json
{
  "chapter_number": 5
}

// è‡ªåŠ¨ä¿®å¤å
{
  "chapter_number": 5,
  "word_count": 0,
  "status": "draft",
  "last_modified": "2025-09-03T12:00:00",
  "auto_fixed": true
}
```

## ç›‘æ§å’ŒæŠ¥å‘Š

### éªŒè¯æ—¥å¿—
`~/.claude/logs/validation.log`
```
[2025-09-03 12:00:00] Validating Chapter Meta: ch001/meta.json
[2025-09-03 12:00:00] âœ“ Validation passed: ch001/meta.json
[2025-09-03 12:00:01] âœ— Validation failed: ch002/content.md
  Errors: Content too short: 45 words
```

### ä¿®å¤æ—¥å¿—
`~/.claude/logs/auto-fixes.log`
```
[2025-09-03 12:00:02] Auto-fixed JSON: ch002/quality_check.json
  Fixes: Removed trailing commas; Added missing fields
```

### å¤±è´¥æŠ¥å‘Š
`~/.claude/validation/failure_*.txt`
- è¯¦ç»†çš„é”™è¯¯æè¿°
- æ–‡ä»¶å†…å®¹é¢„è§ˆ
- ä¿®å¤å»ºè®®

## æ€§èƒ½å½±å“

- âœ… **å¼‚æ­¥æ‰§è¡Œ**ï¼šä¸é˜»å¡ä¸»æµç¨‹
- âœ… **é™é»˜è¿è¡Œ**ï¼šä¸å¹²æ‰°ç”¨æˆ·
- âœ… **è½»é‡çº§**ï¼šåªéªŒè¯å…³é”®æ–‡ä»¶
- âœ… **æ™ºèƒ½åˆ¤æ–­**ï¼šåªä¿®å¤æ˜ç¡®çš„é—®é¢˜

## é…ç½®é€‰é¡¹

åœ¨ `.claude/hooks/config.yaml` ä¸­å¯é…ç½®ï¼š
```yaml
validation:
  enabled: true
  strict_mode: false  # true = é˜»å¡å¼éªŒè¯
  auto_fix: true
  backup_before_fix: true
  
thresholds:
  min_chapter_words: 50
  max_quality_score: 100
  json_depth_limit: 10
```

## æœ€ä½³å®è·µ

1. **å®šæœŸæ£€æŸ¥éªŒè¯æ—¥å¿—**
   - æ¯æ—¥æŸ¥çœ‹ `validation.log`
   - å…³æ³¨åå¤å‡ºç°çš„é—®é¢˜

2. **ä¿ç•™ä¿®å¤å†å²**
   - ä¸è¦åˆ é™¤ `.broken` å¤‡ä»½æ–‡ä»¶
   - ç”¨äºåˆ†æSubagentçš„é—®é¢˜æ¨¡å¼

3. **ä¼˜åŒ–Subagentæç¤ºè¯**
   - æ ¹æ®å¸¸è§é”™è¯¯ä¼˜åŒ–agentæŒ‡ä»¤
   - æ·»åŠ æ ¼å¼éªŒè¯è¦æ±‚åˆ°agentæè¿°ä¸­

4. **äººå·¥å¤æŸ¥å…³é”®æ–‡ä»¶**
   - Bibleå’Œentity_dictionaryéœ€è¦äººå·¥ç¡®è®¤
   - è‡ªåŠ¨ä¿®å¤åªæ˜¯åº”æ€¥æªæ–½

## æ€»ç»“

è¿™ä¸ªä¸‰å±‚ä¿æŠ¤ç³»ç»Ÿç¡®ä¿ï¼š
- ğŸ›¡ï¸ **éªŒè¯å±‚**ï¼šç«‹å³å‘ç°é—®é¢˜
- ğŸ”§ **ä¿®å¤å±‚**ï¼šè‡ªåŠ¨è§£å†³å¸¸è§é—®é¢˜  
- ğŸ‘€ **æé†’å±‚**ï¼šéœ€è¦äººå·¥ä»‹å…¥æ—¶åŠæ—¶é€šçŸ¥
- ğŸ“Š **å­¦ä¹ å±‚**ï¼šç§¯ç´¯é—®é¢˜æ¨¡å¼ï¼ŒæŒç»­æ”¹è¿›

è®©Subagentçš„è¾“å‡ºæ›´å¯é ï¼Œå‡å°‘äººå·¥å¹²é¢„ï¼